name: ğŸš€ Deploy to DigitalOcean

on:
  push:
    branches: [ main ]
    paths:
      - 'main/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: jon-school/api

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: SERVER
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
    
    - name: Log in to DigitalOcean Container Registry
      run: doctl registry login --expiry-seconds 1200
    
    - name: ğŸ—ï¸ Build container image
      run: |
        docker build -t $REGISTRY/$IMAGE_NAME:${{ github.sha }} .
        docker build -t $REGISTRY/$IMAGE_NAME:latest .
    
    - name: Push image to DigitalOcean Container Registry
      run: |
        docker push $REGISTRY/$IMAGE_NAME:${{ github.sha }}
        docker push $REGISTRY/$IMAGE_NAME:latest
    
    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DROPLET_HOST }}
        username: ${{ secrets.DROPLET_USER }}
        key: ${{ secrets.DIGITAL_OCEAN_SSH_KEY }}
        script: |
          # Login to registry
          doctl registry login --expiry-seconds 1200
          
          # Force stop and remove existing container
          echo "ğŸ›‘ Stopping existing container..."
          docker stop speech-analyser-api || true
          docker rm speech-analyser-api || true
          
          # Remove old image to force fresh pull
          echo "ğŸ—‘ï¸ Removing old image..."
          docker rmi registry.digitalocean.com/jon-school/api:latest || true
          
          # Pull latest image with force
          echo "ğŸ“¥ Pulling latest image..."
          docker pull registry.digitalocean.com/jon-school/api:latest --disable-content-trust
          
          # Verify no container with same name exists
          if docker ps -a --filter "name=speech-analyser-api" --format "{{.Names}}" | grep -q "speech-analyser-api"; then
            echo "âš ï¸ Container still exists, force removing..."
            docker rm -f speech-analyser-api
          fi
          
          # Run new container
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name speech-analyser-api \
            --restart unless-stopped \
            -p 8000:8000 \
            -e SUPABASE_URL="${{ secrets.SUPABASE_URL }}" \
            -e SUPABASE_ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}" \
            -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            -e JWT_SIGNING_SECRET="${{ secrets.JWT_SIGNING_SECRET }}" \
            -e GITHUB_REPO="${{ secrets.REPO }}" \
            -e GITHUB_PROVISION_WORKFLOW="${{ secrets.PROVISION_WORKFLOW }}" \
            -e GITHUB_REF="${{ secrets.REF }}" \
            -e GH_PROVISION_TOKEN="${{ secrets.GH_PROVISION_TOKEN }}" \
            -e CP_ENCRYPTION_KEY="${{ secrets.CP_ENCRYPTION_KEY }}" \
            -e SCHOOL_SQL_PATH="/app/prisma/tenant_schema.sql" \
            -e DEFAULT_TENANT_DB_PASSWORD="${{ secrets.DEFAULT_TENANT_DB_PASSWORD }}" \
            -e LOG_LEVEL="INFO" \
            -e AWS_REGION="${{ secrets.AWS_REGION }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            -e S3_BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}" \
            registry.digitalocean.com/jon-school/api:latest
          
          # Verify container is running
          echo "âœ… Verifying deployment..."
          sleep 5
          if docker ps --filter "name=speech-analyser-api" --format "{{.Names}}" | grep -q "speech-analyser-api"; then
            echo "âœ… Container is running"
            docker ps --filter "name=speech-analyser-api"
          else
            echo "âŒ Container failed to start"
            docker logs speech-analyser-api || true
            exit 1
          fi
          
          # Test health endpoint
          echo "ğŸ¥ Testing health endpoint..."
          sleep 10
          if curl -f -s http://localhost:8000/healthz > /dev/null; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            docker logs speech-analyser-api
            exit 1
          fi
          
          # Clean up old images
          docker image prune -f
    
    - name: Deployment Status
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ API available at: https://api.speechanalyser.com"
        echo "ğŸ“š Documentation: https://jonathan-vandenberg.github.io/speech-analysis"
